<!doctype html>

<html>
<head>
	<meta charset='utf-8'>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- <link rel='stylesheet' href='snake.css'> -->
	<title>``Snake'' -- A web game</title>

<style>
body {
	padding: 10px 0 0 0;
}

#el_snake_tab {
	margin-top: 80px;
	width: 300px;
	height: 300px;
	margin: 0 auto;
	border: 1px solid #aaa;
	border-radius: 3px;
} #el_snake_tab td {
	text-align: center;
	line-height: 100%;
}

.paused .td-empty {
	background: #ccc;
}

.grey .td-snake {
	background: grey;
}

#info {
	text-align: center;
	line-height: 2em;
}

#dir_ctrl {
	width: 180px;
	height: 180px;
	margin: 0 auto;
	text-align: center;
} /* #dir_ctrl */ .dir-ctrl-button {
	font-size: 16px;
	width: 33.3%;
	background: black;
	color: white;
	/* border: 1px solid black; */
	border-radius: 10px;
} .dir-ctrl-button:active {
	background: white;
	color: black;
}

.td-empty {
	background: white;
}

.td-snake {
	background: black;
}

.td-food {
	border-radius: 3px;
	background: red;
}


</style>


</head>

<body>
<table id='el_snake_tab'>

<tr> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td>
<td> </td> <td> </td> <td> </td> <td> </td> <td> </td> </tr>
<tr> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td>
<td> </td> <td> </td> <td> </td> <td> </td> <td> </td> </tr>
<tr> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td>
<td> </td> <td> </td> <td> </td> <td> </td> <td> </td> </tr>
<tr> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td>
<td> </td> <td> </td> <td> </td> <td> </td> <td> </td> </tr>
<tr> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td>
<td> </td> <td> </td> <td> </td> <td> </td> <td> </td> </tr>
<tr> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td>
<td> </td> <td> </td> <td> </td> <td> </td> <td> </td> </tr>
<tr> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td>
<td> </td> <td> </td> <td> </td> <td> </td> <td> </td> </tr>
<tr> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td>
<td> </td> <td> </td> <td> </td> <td> </td> <td> </td> </tr>
<tr> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td>
<td> </td> <td> </td> <td> </td> <td> </td> <td> </td> </tr>
<tr> <td> </td> <td> </td> <td> </td> <td> </td> <td> </td>
<td> </td> <td> </td> <td> </td> <td> </td> <td> </td> </tr>

</table>

<div id='info'>To <b>PAUSE</b>, press space or the screen above (&uarr;)</div>
<table id='dir_ctrl'>

<tr> <td></td> <td  class='dir-ctrl-button' id='dir_ctrl_up'>&uarr;</td> <td></td> </tr>
<tr> <td class='dir-ctrl-button' id='dir_ctrl_left'>&larr;</td> <td id='dir_ctrl_middle'></td> <td class='dir-ctrl-button' id='dir_ctrl_right'>&rarr;</td> </tr>
<tr> <td></td> <td class='dir-ctrl-button' id='dir_ctrl_down'>&darr;</td> <td></td> </tr>
</table>
</body>

<script>
function Snake() {
	this.body = []; //body[0] is head, body[len-1] is tail
	this.d = 'r' // right
	this.dmap = {
		'd': { r: 1,  c: 0  },
		'u': { r: -1, c: 0  },
		'l': { r: 0,  c: -1 },
		'r': { r: 0,  c: 1  }
	}
	for (var i = 5; i > 0; i -= 1) {
		this.body.push({r: 3, c: i})
	}
}

Snake.prototype.GetLength = function() {
	return this.body.length
}

Snake.prototype.SetDirection = function(ch) {
	var oppo = {
		'd': 'u',
		'u': 'd',
		'l': 'r',
		'r': 'l'
	}
	if (oppo[ch] !== this.d) {
		this.d = ch
	}
}

Snake.prototype.Grow = function() {
	var oldhead = this.body[0]
	var newhead = {r: 0, c: 0}
	var d = this.dmap[this.d]
	newhead.r = (oldhead.r + d.r) % 10;
	if (newhead.r < 0) {
		newhead.r = 10 + newhead.r;
	}
	newhead.c = (oldhead.c + d.c) % 10;
	if (newhead.c < 0) {
		newhead.c = 10 + newhead.c;
	}
	this.body.unshift(newhead)
}

Snake.prototype.Move = function() {
	this.Grow()
	this.body.pop()
}

Snake.prototype.IsGonnaReach = function(r, c) {
	var head = this.body[0]
	var d = this.dmap[this.d]
	return (r === head.r + d.r) && (c === head.c + d.c)
}

Snake.prototype.IsAlive = function() {
	var arr = [] // like a hashset
	var r = 0, c = 0, pos = 0;
	for (var i = 0; i < this.body.length; i += 1) {
		r = this.body[i].r;
		c = this.body[i].c;
		pos = r * 10 + c;
		if (arr[pos] !== undefined) {
			return false;
		}
		arr[pos] = 1
	}
	return true;
}

Snake.prototype.GetMatrix = function() {
	var mat = []
	var r = 0, c = 0;

	for (var r = 0; r < 10; r += 1) {
		var newrow = []
		for (var c = 0; c < 10; c += 1) {
			newrow.push(0)
		}
		mat.push(newrow)
	}
	for (var i = 0; i < this.body.length; i += 1) {
		r = this.body[i].r;
		c = this.body[i].c;
		mat[r][c] = 1;
	}

	return mat
}

function Ui() {
	this.cells = [] // Arr<EL.td>
	this.classes = ["td-empty", "td-snake", "td-food"]
	this.snaketab = el_snake_tab // doc.getel.byID
	this.infodiv = info;

	var rows = this.snaketab.rows
	for (var r = 0; r < rows.length; r += 1) {
		 this.cells.push(rows[r].cells)
	}
}

Ui.prototype.TogglePause = function() {
	this.infodiv.innerHTML =
		"To <b>RUN</b>, press space or the screen above (&uarr;)"
	this.snaketab.classList.toggle("paused")
}

Ui.prototype.Unset = function() {
	this.infodiv.innerHTML =
		"To <b>PAUSE</b>, press space or the screen above (&uarr;)"
	this.snaketab.className = ""
}

Ui.prototype.SetGameOver = function() {
	this.infodiv.innerHTML =
		"To <b>RESTART</b>, press space or the screen above (&uarr;)"
	this.snaketab.classList.add("grey")
}

Ui.prototype.ShowScore = function(score) {
	dir_ctrl_middle.innerText = score.toString()
}

Ui.prototype.DrawMatrix = function(mat) {
	for (var r = 0; r < mat.length; r += 1) {
		for (var c = 0; c < mat[r].length; c += 1) {
			//this.cells[r][c].classList = [this.classes[mat[r][c]]];
			this.cells[r][c].className = "";
			this.cells[r][c].classList.add(this.classes[mat[r][c]]);
		}
	}
}

// TODO More elegant event binding is required
function Main(snake_module_ctor, ui_module_ctor) {
	this.ui = new ui_module_ctor()
	this.snake = new snake_module_ctor()
	this.foodr = 0;
	this.foodc = 0;
	this.timer = undefined;
	//this.started = false;
	this.paused = false;
	//this.mobile = false;

	//this.moveSnake();
	this.run()
}

Main.prototype.setFood = function() { 
	//this.foodr = Math.floor(Math.random() * 10)
	//this.foodc = Math.floor(Math.random() * 10)
	var mat = this.snake.GetMatrix()
	var empties = [];
	var i = 0;

	for (var r = 0; r < mat.length; r += 1) {
		for (var c = 0; c < mat[r].length; c += 1) {
			if (mat[r][c] === 0) { // nothing inside
				empties.push({'r': r, 'c': c})
			}
		}
	}
	i = Math.floor(Math.random() * empties.length)
	this.foodr = empties[i].r;
	this.foodc = empties[i].c;
}

Main.prototype.moveSnake = function() {
	if (this.snake.IsGonnaReach(this.foodr, this.foodc)) {
		this.snake.Grow()
		this.setFood()
	} else {
		this.snake.Move()
	}
	var mat = this.snake.GetMatrix()
	mat[this.foodr][this.foodc] = 2;
	this.ui.DrawMatrix(mat)
}

Main.prototype.TogglePause = function() {
	this.ui.TogglePause()
	this.paused = !this.paused;
}

Main.prototype.bindKeyboardEvents = function() {
	var main = this;

	document.body.onkeydown = function(ev) {
		main.mobile = false;
		//console.log("key")
		var keymap = {
			87:'u',
			65:'l',
			83:'d',
			68:'r'
		};
		ev = ev || window.event;
		ev = ev.keyCode || ev.which;
		if (ev === 32) {
			main.TogglePause()
			return
		}
		var dchar = keymap[ev]
		if (dchar !== undefined) {
			main.snake.SetDirection(dchar)
		}
	}
}

Main.prototype.UnbindClickEvents = function() {
	el_snake_tab.onclick = undefined;
	dir_ctrl_up.onclick = undefined;
	dir_ctrl_down.onclick = undefined;
	dir_ctrl_left.onclick = undefined;
	dir_ctrl_right.onclick = undefined;
}

Main.prototype.bindPressEvents = function() {
	var main = this;

	el_snake_tab.ontouchstart = function(ev) {
		main.UnbindClickEvents()
		main.TogglePause()

		dir_ctrl_up.ontouchstart = function() {
			if (!main.paused) main.snake.SetDirection('u')
		}
		dir_ctrl_down.ontouchstart = function() {
			if (!main.paused) main.snake.SetDirection('d')
		}
		dir_ctrl_left.ontouchstart = function() {
			if (!main.paused) main.snake.SetDirection('l')
		}
		dir_ctrl_right.ontouchstart = function() {
			if (!main.paused) main.snake.SetDirection('r')
		}
	}

	el_snake_tab.onclick = function() {
		main.TogglePause()
	}

	dir_ctrl_up.onclick = function() {
		if (!main.paused) main.snake.SetDirection('u')
	}
	dir_ctrl_down.onclick = function() {
		if (!main.paused) main.snake.SetDirection('d')
	}
	dir_ctrl_left.onclick = function() {
		if (!main.paused) main.snake.SetDirection('l')
	}
	dir_ctrl_right.onclick = function() {
		if (!main.paused) main.snake.SetDirection('r')
	}
}

Main.prototype.run = function() {
	var main = this;

	//main.ui.SetPrestart()
	main.bindKeyboardEvents()
	main.bindPressEvents()
	main.timer = setInterval(function() {
		if (!main.paused) {
			main.ui.Unset()
			main.moveSnake()
			main.ui.ShowScore(main.snake.GetLength())
			if (!main.snake.IsAlive()) {
				main.ui.SetGameOver()
				document.body.onkeydown = function(e) {
					e = e || window.event;
					e = e.keyCode || e.which;
					if (e === 32) {
						new Main(Snake, Ui)
					}
				}
				el_snake_tab.onclick = function() {
					new Main(Snake, Ui)
				}
				clearInterval(main.timer)
			}
		}
	}, 500)
}

/* var MAIN = */new Main(Snake, Ui)

</script>

</html>
